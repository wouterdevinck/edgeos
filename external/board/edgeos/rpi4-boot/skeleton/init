#!/bin/sh
set -e

mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t devtmpfs devtmpfs /dev

fail_shell() {
  echo "$@"
  exec sh
}

exec 0</dev/console
exec 1>/dev/console
exec 2>/dev/console

sleep 1

DT_BOOTLOADER_PARTITION=/proc/device-tree/chosen/bootloader/partition
BOOTPART=$(printf "%d" "0x$(od "${DT_BOOTLOADER_PARTITION}" -v -An -t x1 | tr -d ' ' )")

if ! mount /dev/mmcblk0p$((BOOTPART+3)) /mnt; then
  fail_shell "Failed to mount rootfs, dropping to a shell"
fi

cat << "EOF"

  ______    _             ____   _____ 
 |  ____|  | |           / __ \ / ____|
 | |__   __| | __ _  ___| |  | | (___  
 |  __| / _` |/ _` |/ _ \ |  | |\___ \ 
 | |___| (_| | (_| |  __/ |__| |____) |
 |______\__,_|\__, |\___|\____/|_____/ 
               __/ |                   
              |___/                    

EOF

mount --move /sys /mnt/sys
mount --move /proc /mnt/proc
mount --move /dev /mnt/dev

exec switch_root -c /dev/console /mnt /sbin/init
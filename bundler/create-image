#!/bin/bash

set -e
set -o pipefail

MANIFEST_FILE="$(pwd)/manifest.json"
DOCKER_COMPOSE_FILE="$(pwd)/docker-compose.yml"

IMAGE_NAME="disk.img"
IMAGE_NAME_COMPRESSED="disk.img.gz"

WORKDIR="tmp"

# Read manifest file
source read-manifest $MANIFEST_FILE

# Info message
echo "Creating SD card image for $APP_NAME version $APP_VERSION"

# Create working directory
rm -rf $WORKDIR
mkdir -p $WORKDIR
pushd $WORKDIR > /dev/null

# Get EdgeOS release, containing boot partitions and rootfs image
get-os $EDGEOS_VERSION

# Create partition with manifest and compose files
echo "  Creating manifest partition"
mksquashfs $MANIFEST_FILE $DOCKER_COMPOSE_FILE manifest.squashfs > /dev/null 2>&1

# Run genimage
echo "  Creating image"
BUILD_DIR=$(pwd) fakeroot genimage.sh -c /data/rpi4-genimage.cfg > /dev/null 2>&1

# Compress image
echo "  Compressing image"
gzip $IMAGE_NAME $IMAGE_NAME_COMPRESSED > /dev/null 2>&1

# Copy output
popd > /dev/null
cp $WORKDIR/$IMAGE_NAME_COMPRESSED .

# Clean up
rm -rf $WORKDIR
echo "  Done."